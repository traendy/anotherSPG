# Simple Android Dockerfile

Some people are using amazing tools like bitriste or gitlab. 
Others have reasons to use jenkins.

Recently I had the joy to create a docker container for our Jenkins Build Automation after we moved to AWS.

The easiest way to get your hands on a Dockerfile which contains a build enviroment for your Android builds is to invest time in DockerHub and check out all the solutions other developers invented.

## The problem is as always one does not fit all.

I found some Dockerfiles and tried to adjust them until it worked for some cases.
I blindly kept all the stuff someone from the internet needed in his/her builds.
But it did not fit. The image grew to nearly 4 gb wich just wastes time on a cold start in AWS.

After many tries and a lot of reading and talking to coworkers the result was this:

```
FROM ubuntu:18.04

ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get -qqy update && \
    apt-get -qqy --no-install-recommends install \
    openjdk-8-jdk-headless \
    ca-certificates \
    tzdata \
    git \
    zip \
    unzip \
    wget \
    curl \
  && rm -rf /var/lib/apt/lists/*

RUN groupadd --gid 1000 builduser \
  && useradd --uid 1000 --gid 1000 --create-home --shell /bin/bash builduser
USER builduser
WORKDIR /home/builduser
ENV HOME /home/builduser

ENV SDK_HOME /usr/local
ENV ANDROID_HOME ${HOME}/android-sdk-linux
ENV GRADLE_HOME ${HOME}/gradle

ENV PATH ${PATH}:${GRADLE_HOME}/bin:${ANDROID_HOME}/tools:${ANDROID_HOME}/platform-tools:${ANDROID_HOME}/tools/bin

# Download Android SDK into $ANDROID_HOME
# You can find URL to the current version at: https://developer.android.com/studio/index.html
# Also, remove monitor-x86 to save ~50MB. Does anyone still use x86?
RUN mkdir -p ${ANDROID_HOME} && \
    cd ${ANDROID_HOME} && \
    wget -q https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip -O android_tools.zip && \
    unzip android_tools.zip && \
    rm android_tools.zip && \
    rm -rf tools/lib/monitor-x86

ENV PATH ${PATH}:${ANDROID_HOME}/tools:${ANDROID_HOME}/tools/bin:${ANDROID_HOME}/platform-tools

# Accept Android SDK licenses
RUN yes | sdkmanager --licenses

# https://askubuntu.com/questions/885658/android-sdk-repositories-cfg-could-not-be-loaded
RUN touch ~/.android/repositories.cfg

# Copy the debug.keystore. This is required so debug APKs can be upgraded. For
# generating the keystore, the option `-keysize 1024` was required. Otherwise,
# v1 signature generation failed because of invalid key size for SHA1withDSA
# requirements.
#
# Full keystore generation command:
#
# keytool -genkey -v -validity 10000 -keysize 1024 -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -dname 'CN=Android Debug,O=Android,C=DE'
#
COPY --chown=builduser debug.keystore ${HOME}/.android/debug.keystore

```

## Clean user
The most time I wasted in the user which led to workaround which led to a coworker fixing it for me.

```
RUN groupadd --gid 1000 builduser \
  && useradd --uid 1000 --gid 1000 --create-home --shell /bin/bash builduser
USER builduser
WORKDIR /home/builduser
ENV HOME /home/builduser
```

Without the `builduser` and `WORKDIR` I needed wildcards in my path which worked but was ugly and counterintuitive.

## `Warning: File /home/xxxx/.android/repositories.cfg could not be loaded.`

Many have this problem and the solution is as easy as one can imaging.
Just add: `RUN touch ~/.android/repositories.cfg`
The file contains sources for user defined repositories and I have no clue why this file is not generated by when the sdkmanager is run the first time.

## Building debug artifacts 

If you are interessted in a Dockerfile for Android builds. You may desire to run parallel builds. For example one person builds an apk using this image and installs it to his/her device. After a change he is interessted in building again and updating the previous installation. But this time the previous build enviroment was consumend or shut down. It is not guranteed that two builds of the same code base run in the same build enviroment and every enviroment will get its own debug.keystore.
Apps signed with a different key even if the package name is consistent cannot update each other.

So there are basically two possibilities here.

You can either commit a debug.keystore to your application repository and change your build configuration to use it. 
Or you can copy a pregenerated debug.keystore as it is shown in this Dockerfile.

```
COPY --chown=builduser debug.keystore ${HOME}/.android/debug.keystore
```

## Final words

There is more to build enviroments and this may not fit your progress. But maybe it inspires you for a fix for an issue you face with your Android Dockerfile implementation.

Thanks for reading.



